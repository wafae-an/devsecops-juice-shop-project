name: Security Scanning Pipeline

# Manual trigger for comprehensive security analysis
on:
  workflow_dispatch:
  schedule:
    # Run weekly security scans (every Monday at 2 AM UTC)
    - cron: '0 2 * * 1'

jobs:
  # Job 1: Static Application Security Testing (SAST) with CodeQL
  sast-codeql:
    name: SAST - CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Initialize CodeQL for JavaScript/TypeScript analysis
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality
      
      # Setup Node.js for building the application
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # Install dependencies for analysis
      - name: Install dependencies
        run: npm ci
      
      # Perform CodeQL analysis
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"
        continue-on-error: true
      
      # Export SAST results as SARIF file
      - name: Export SAST report
        if: always()
        run: |
          mkdir -p reports
          echo "CodeQL SAST scan completed at $(date)" > reports/sast-report.txt
          echo "Repository: ${{ github.repository }}" >> reports/sast-report.txt
          echo "Commit: ${{ github.sha }}" >> reports/sast-report.txt
      
      # Upload SAST results as artifact
      - name: Upload SAST report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-report
          path: reports/sast-report.txt
          retention-days: 90

  # Job 2: Software Composition Analysis (SCA) with Snyk
  sca-snyk:
    name: SCA - Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # Install dependencies for scanning
      - name: Install dependencies
        run: npm ci
      
      # Run Snyk dependency scan
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --json-file-output=sca-report.json --severity-threshold=medium
      
      # Generate human-readable SCA report
      - name: Generate SCA summary
        if: always()
        run: |
          mkdir -p reports
          echo "=== Snyk SCA Vulnerability Report ===" > reports/sca-summary.txt
          echo "Scan Date: $(date)" >> reports/sca-summary.txt
          echo "Repository: ${{ github.repository }}" >> reports/sca-summary.txt
          echo "Branch: ${{ github.ref_name }}" >> reports/sca-summary.txt
          echo "======================================" >> reports/sca-summary.txt
          if [ -f sca-report.json ]; then
            echo "Detailed results available in sca-report.json" >> reports/sca-summary.txt
            mv sca-report.json reports/
          else
            echo "No vulnerabilities detected or scan failed" >> reports/sca-summary.txt
          fi
      
      # Upload SCA results as artifact
      - name: Upload SCA report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sca-report
          path: reports/
          retention-days: 90

  # Job 3: Dynamic Application Security Testing (DAST) with OWASP ZAP
  dast-zap:
    name: DAST - OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest
    
    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Setup Node.js for running Juice Shop
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # Install dependencies
      - name: Install dependencies
        run: npm ci
      
      # Build the application
      - name: Build Juice Shop
        run: npm run build
      
      # Start Juice Shop application in background
      - name: Start Juice Shop application
        run: |
          npm start &
          echo "Waiting for application to start..."
          sleep 30
          # Verify application is running
          curl -f http://localhost:3000 || exit 1
          echo "Application is ready for DAST scanning"
      
      # Alternative: Start Juice Shop using Docker (more reliable)
      # Uncomment this section if you prefer Docker-based deployment
      # - name: Start Juice Shop with Docker
      #   run: |
      #     docker run -d -p 3000:3000 --name juice-shop bkimminich/juice-shop
      #     echo "Waiting for container to start..."
      #     sleep 20
      #     curl -f http://localhost:3000 || exit 1
      
      # Run OWASP ZAP baseline scan
      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -l WARN'
        continue-on-error: true
      
      # Create reports directory and move ZAP results
      - name: Prepare DAST reports
        if: always()
        run: |
          mkdir -p reports
          echo "=== OWASP ZAP DAST Report ===" > reports/dast-summary.txt
          echo "Scan Date: $(date)" >> reports/dast-summary.txt
          echo "Target URL: http://localhost:3000" >> reports/dast-summary.txt
          echo "Scan Type: Baseline" >> reports/dast-summary.txt
          echo "=============================" >> reports/dast-summary.txt
          
          # Move ZAP reports if they exist
          if [ -f report_html.html ]; then
            mv report_html.html reports/dast-report.html
            echo "HTML report: dast-report.html" >> reports/dast-summary.txt
          fi
          
          if [ -f report_json.json ]; then
            mv report_json.json reports/dast-report.json
            echo "JSON report: dast-report.json" >> reports/dast-summary.txt
          fi
          
          if [ -f report_md.md ]; then
            mv report_md.md reports/dast-report.md
            echo "Markdown report: dast-report.md" >> reports/dast-summary.txt
          fi
      
      # Stop the application
      - name: Stop Juice Shop
        if: always()
        run: |
          pkill -f "node.*juice-shop" || true
          # If using Docker, uncomment:
          # docker stop juice-shop || true
          # docker rm juice-shop || true
      
      # Upload DAST results as artifact
      - name: Upload DAST report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-report
          path: reports/
          retention-days: 90

  # Job 4: Consolidate all security reports
  consolidate-reports:
    name: Consolidate Security Reports
    runs-on: ubuntu-latest
    needs: [sast-codeql, sca-snyk, dast-zap]
    if: always()
    
    steps:
      # Download all security reports
      - name: Download SAST report
        uses: actions/download-artifact@v4
        with:
          name: sast-report
          path: consolidated-reports/sast/
        continue-on-error: true
      
      - name: Download SCA report
        uses: actions/download-artifact@v4
        with:
          name: sca-report
          path: consolidated-reports/sca/
        continue-on-error: true
      
      - name: Download DAST report
        uses: actions/download-artifact@v4
        with:
          name: dast-report
          path: consolidated-reports/dast/
        continue-on-error: true
      
      # Create master security report
      - name: Generate consolidated security report
        run: |
          echo "========================================" > consolidated-reports/security-scan-summary.txt
          echo "   DevSecOps Security Scan Results" >> consolidated-reports/security-scan-summary.txt
          echo "========================================" >> consolidated-reports/security-scan-summary.txt
          echo "" >> consolidated-reports/security-scan-summary.txt
          echo "Scan Date: $(date)" >> consolidated-reports/security-scan-summary.txt
          echo "Repository: ${{ github.repository }}" >> consolidated-reports/security-scan-summary.txt
          echo "Commit: ${{ github.sha }}" >> consolidated-reports/security-scan-summary.txt
          echo "Triggered by: ${{ github.actor }}" >> consolidated-reports/security-scan-summary.txt
          echo "" >> consolidated-reports/security-scan-summary.txt
          echo "========================================" >> consolidated-reports/security-scan-summary.txt
          echo "Report Structure:" >> consolidated-reports/security-scan-summary.txt
          echo "  - sast/     : Static Analysis (CodeQL)" >> consolidated-reports/security-scan-summary.txt
          echo "  - sca/      : Dependency Scan (Snyk)" >> consolidated-reports/security-scan-summary.txt
          echo "  - dast/     : Dynamic Scan (OWASP ZAP)" >> consolidated-reports/security-scan-summary.txt
          echo "========================================" >> consolidated-reports/security-scan-summary.txt
          
          # List all available reports
          echo "" >> consolidated-reports/security-scan-summary.txt
          echo "Available Report Files:" >> consolidated-reports/security-scan-summary.txt
          find consolidated-reports -type f >> consolidated-reports/security-scan-summary.txt
      
      # Upload consolidated report
      - name: Upload consolidated security reports
        uses: actions/upload-artifact@v4
        with:
          name: all-security-reports
          path: consolidated-reports/
          retention-days: 90
